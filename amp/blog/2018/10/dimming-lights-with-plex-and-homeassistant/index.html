<!doctype html>
<html amp lang="en">



  <meta charset="utf-8">
  <title>How I Dim My Hue Lights with a Plex Webhook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

  <!-- Chrome, Firefox OS and Opera -->
  <meta name="theme-color" content="#3d256d">
  <!-- Windows Phone -->
  <meta name="msapplication-navbutton-color" content="#3d256d">

  <!-- Contain all special checks needed on AMP pages. Attempt to consolidate checks. -->


  
  <!-- Extract extra <title> tag. -->
  
  
  
  

  
  
  
  

  
    <!-- Assumes AmpDir is always first instance in page.url based on how amp-jekyll builds it -->
    
    

    <!-- Begin Jekyll SEO tag v2.6.1 -->

<meta name="generator" content="Jekyll v3.8.6">

<meta name="author" content="Kyle Niewiada">
<meta property="og:locale" content="en_US">
<meta name="description" content="How I use the new webhooks endpoints added to Home Assistant to trigger dimming the lights when my media starts on Plex.">
<meta property="og:description" content="How I use the new webhooks endpoints added to Home Assistant to trigger dimming the lights when my media starts on Plex.">
<link rel="canonical" href="/blog/2018/10/dimming-lights-with-plex-and-homeassistant/">
<meta property="og:url" content="/blog/2018/10/dimming-lights-with-plex-and-homeassistant/">
<meta property="og:site_name" content="Kyle Niewiada’s Website">
<meta property="og:image" content="https://www.kyleniewiada.org/assets/img/2018/10/banner.jpg">
<meta property="og:image:height" content="398">
<meta property="og:image:width" content="700">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-10-18T16:47:00-04:00">
<meta name="twitter:card" content="summary_large_image">
<meta property="twitter:image" content="https://www.kyleniewiada.org/assets/img/2018/10/banner.jpg">
<meta property="twitter:title" content="How I Dim My Hue Lights with a Plex Webhook">
<meta name="twitter:site" content="@CrypticCitrus">
<meta name="twitter:creator" content="@CrypticCitrus">
<meta property="fb:app_id" content="137961485759">
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://www.kyleniewiada.org/assets/img/logo.png"},"name":"Kyle Niewiada"},"headline":"How I Dim My Hue Lights with a Plex Webhook","dateModified":"2019-01-18T16:19:31-05:00","datePublished":"2018-10-18T16:47:00-04:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/blog/2018/10/dimming-lights-with-plex-and-homeassistant/"},"image":{"height":398,"width":700,"url":"https://www.kyleniewiada.org/assets/img/2018/10/banner.jpg","@type":"imageObject"},"url":"/blog/2018/10/dimming-lights-with-plex-and-homeassistant/","author":{"@type":"Person","name":"Kyle Niewiada"},"description":"How I use the new webhooks endpoints added to Home Assistant to trigger dimming the lights when my media starts on Plex.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  



  <style amp-custom>
  
  @font-face{font-family:'Open Sans';font-style:normal;font-weight:300;src:local("Open Sans Light"),local("OpenSans-Light"),url("/assets/fonts/open-sans-v13-latin-300.woff2") format("woff2"),url("/assets/fonts/open-sans-v13-latin-300.woff") format("woff")}@font-face{font-family:'Open Sans';font-style:normal;font-weight:400;src:local("Open Sans"),local("OpenSans"),url("/assets/fonts/open-sans-v13-latin-regular.woff2") format("woff2"),url("/assets/fonts/open-sans-v13-latin-regular.woff") format("woff")}@font-face{font-family:'Open Sans';font-style:normal;font-weight:600;src:local("Open Sans Semibold"),local("OpenSans-Semibold"),url("/assets/fonts/open-sans-v13-latin-600.woff2") format("woff2"),url("/assets/fonts/open-sans-v13-latin-600.woff") format("woff")}.page-title{text-align:left;font-size:200%;line-height:1.2;font-weight:normal}@media (min-width: 600px){.page-title{font-size:250%}}@media (min-width: 1000px){.page-title{font-size:300%}}.meta{color:#696969;font-weight:300;font-size:120%}@media (min-width: 600px){.meta{font-size:130%}}@media (min-width: 1000px){.meta{font-size:140%}}a.meta{text-align:center;display:block}.title-meta{overflow:auto;color:#696969;font-size:100%}h1,.h1,h2,.h2,h3,.h3,h4,.h4,h5,.h5,h6,.h6{margin:0 0 .5rem;font-weight:600}a{color:#3d256d}a:hover{color:#1d1234}code,pre{border-radius:.2em;background-color:#f5f5f5;border:0.1em solid #d3d3d3}code{padding:2px 4px;color:#9e023b}pre{padding:16px;overflow-y:hidden}pre code{color:inherit;background-color:transparent;padding:0;border:0}body{margin:0}body,p,li,ul,input,textarea{font-size:1em;line-height:1.58;color:#111;font-family:"Open Sans",Helvetica,Arial,sans-serif}img,video,audio,iframe,object{max-width:100%}main{display:block}.line-separator{height:2px;background:#d3d3d3;margin-top:16px;margin-bottom:16px}.clearfix:after{content:"";display:block;clear:both}.content{max-width:700px;margin-right:auto;margin-left:auto;padding:0 16px}.content img{display:block;margin-left:auto;margin-right:auto}.no-list{list-style:none;padding-left:0;margin-left:0}.left{float:left}.right{float:right}.post-list li{margin-bottom:4em;position:relative}.post-list li:before{content:"";position:absolute;bottom:-2em;left:0;background:#e6e6e6;height:2px;width:60px}.post-list li a{text-decoration:none}.post-list li a:hover{text-decoration:underline}.post-list li .date{color:#696969;font-size:.8em}.header-amp{background:#262626;margin-bottom:16px;padding:16px;text-align:center;font-size:1.4em;font-weight:normal}.header-amp a,.header-amp a:hover{color:#fff;text-decoration:none;overflow:visible}


  

  
  footer{padding:16px 0}footer .flex-list{position:relative;margin:1em;overflow:hidden;border-top:1px solid #d3d3d3}footer .flex-list ul{display:flex;flex-direction:row;flex-wrap:wrap;justify-content:space-between;margin-left:-1px;padding:0}footer .flex-list li{list-style:none;flex-grow:1;flex-basis:auto;margin:.25em 0;padding:0 1em;text-align:center;border-left:1px solid #ccc;background-color:#fff}@media (min-width: 600px){footer .flex-list li{font-size:110%}}footer a{text-decoration:none}footer a:hover{background:#3d256d;color:white}article img+em,article amp-img+em,article video+em{text-align:center;font-size:.9em;font-style:italic;color:#5e5e5e;display:block}article img+p,article amp-img+p{margin-bottom:2em}blockquote{background:#ffa;border-left:10px solid #dc0;margin:1.5em 10px;padding:0.5em 10px}.post-nav{display:flex;flex-direction:column}.post-nav .post-nav-link{height:6em;margin:.1em;overflow:hidden;position:relative}.post-nav .post-nav-link .link-text{z-index:1;position:absolute;height:100%;width:100%;box-sizing:border-box;padding:.5em;font-weight:bold;color:white;background:rgba(0,0,0,0.6)}.post-nav .post-nav-link .previous{text-align:left}.post-nav .post-nav-link .next{text-align:right}.post-nav .post-nav-link .link-image{position:absolute;filter:blur(1px);transition:all 0.35s ease-in-out;top:50%;transform:translateY(-50%);width:auto;height:auto;min-width:100%;min-height:100%}.post-nav .post-nav-link:hover img{transform:translateY(-50%) scale(1.2)}@media all and (min-width: 600px){.post-nav{flex-direction:row}.post-nav .post-nav-link{flex-basis:0;flex-grow:1}}.button-outline{line-height:1.2em;padding:.5em 1.5em;border-radius:4px;text-decoration:none;cursor:pointer}.button-outline{background-color:transparent;border:3px solid #3d256d;color:#3d256d}.button-outline:hover{background-color:#3d256d;color:#fff}.highlight .c{color:#999988;font-style:italic}.highlight .err{color:#a61717;background-color:#e3d2d2}.highlight .k{font-weight:bold}.highlight .o{font-weight:bold}.highlight .cm{color:#999988;font-style:italic}.highlight .cp{color:#999999;font-weight:bold}.highlight .c1{color:#999988;font-style:italic}.highlight .cs{color:#999999;font-weight:bold;font-style:italic}.highlight .gd{color:#000000;background-color:#fdd}.highlight .gd .x{color:#000000;background-color:#faa}.highlight .ge{font-style:italic}.highlight .gr{color:#a00}.highlight .gh{color:#999}.highlight .gi{color:#000000;background-color:#dfd}.highlight .gi .x{color:#000000;background-color:#afa}.highlight .go{color:#888}.highlight .gp{color:#555}.highlight .gs{font-weight:bold}.highlight .gu{color:#aaa}.highlight .gt{color:#a00}.highlight .kc{font-weight:bold}.highlight .kd{font-weight:bold}.highlight .kp{font-weight:bold}.highlight .kr{font-weight:bold}.highlight .kt{color:#445588;font-weight:bold}.highlight .m{color:#099}.highlight .s{color:#d14}.highlight .na{color:teal}.highlight .nb{color:#0086B3}.highlight .nc{color:#445588;font-weight:bold}.highlight .no{color:teal}.highlight .ni{color:purple}.highlight .ne{color:#990000;font-weight:bold}.highlight .nf{color:#990000;font-weight:bold}.highlight .nn{color:#555}.highlight .nt{color:navy}.highlight .nv{color:teal}.highlight .ow{font-weight:bold}.highlight .w{color:#bbb}.highlight .mf{color:#099}.highlight .mh{color:#099}.highlight .mi{color:#099}.highlight .mo{color:#099}.highlight .sb{color:#d14}.highlight .sc{color:#d14}.highlight .sd{color:#d14}.highlight .s2{color:#d14}.highlight .se{color:#d14}.highlight .sh{color:#d14}.highlight .si{color:#d14}.highlight .sx{color:#d14}.highlight .sr{color:#009926}.highlight .s1{color:#d14}.highlight .ss{color:#990073}.highlight .bp{color:#999}.highlight .vc{color:teal}.highlight .vg{color:teal}.highlight .vi{color:teal}.highlight .il{color:#099}

  </style>

  <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>

  <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
  <script async src="https://cdn.ampproject.org/v0.js"></script>
  
  



<body>
<amp-analytics type="googleanalytics">
  <script type="application/json">
  {
    "vars": {
      "account": "UA-37567352-1"
    },
    "triggers": {
      "trackPageview": {
        "on": "visible",
        "request": "pageview"
      }
    }
  }
  </script>
</amp-analytics>



<!-- start header -->
<header>
  <h1 class="header-amp">
    <a href="/">Kyle Niewiada</a>
  </h1>
</header>
<!-- end header -->



<main class="content">
  <article>
    <div class="post_info">
      <h1 class="page-title">How I Dim My Hue Lights with a Plex Webhook</h1>

      <h2 class="meta">Kyle Niewiada

      <h3 class="meta">October 18, 2018 | 9 Minute Read</h3>

      
      <div class="featuredImage">
        <amp-img src="/assets/img/2018/10/banner.jpg" alt="My Home Assistant dashboard" width="700" height="398" layout="responsive"><noscript><img src="/assets/img/2018/10/banner.jpg" alt="My Home Assistant dashboard" width="700" height="398"></noscript></amp-img>
      </div>
      

      <div class="line-separator"></div>

    </h2>
</div>

    <p>Last week, the Home Assistant project launched webhooks triggers for automations. This means a user could create an endpoint to be hit from an external source and start a task. In my case, I wanted to use webhooks from Plex to dim (or brighten) my lights as quickly as possible.</p>

<h2 id="problems-with-other-methods">Problems with other methods</h2>

<p>Let me be upfront. Plex webhooks are only available to users to are subscribed to PlexPass. I also want to note that this requires a Home Assistant instance to be set up with the ability to control the lights. In my case, I’m using Hue bulbs because of their fairly open API. Before landing on using webhooks through Home Assistant, I considered a few other options to automate my lights.</p>

<h3 id="hellohue">HelloHue</h3>

<p>One common method of controlling the lighting with Plex playback is using <a href="https://github.com/ledge74/HelloHue.bundle">HelloHue</a>. The issue here is that plugins are becoming deprecated with Plex, and I can’t control more complicated automations. For example, I have an automation to make sure my lights won’t dim if I am preparing a meal in the kitchen.</p>

<h3 id="tautulli">Tautulli</h3>

<p>Another common method of controlling lights with Plex is using <a href="https://github.com/Tautulli/Tautulli">Tautulli</a>. Tautulli can be set up to watch for certain playback behaviors, filter users, and post an MQTT message to a channel that Home Assistant is watching. This is an <em>OK</em> method, but I found that this introduced a small amount of lag and would require another application to be working at all times if I didn’t want my lighting automations to hiccup.</p>

<h3 id="node-red">Node-RED</h3>

<p>The last option that I had considered (and used for quite some time), was adding a webhook endpoint inside of Node-RED. This was an <em>OK</em> method as well, but I try to keep things secure. My problem with this method is the following:</p>

<ol>
  <li>I prefer to avoid exposing local network applications to the internet without it being necessary.</li>
  <li>I prefer to access local network applications with <code class="highlighter-rouge">SSL</code>. If it’s an internal app, I will use a self-signed certificate by my local CA. If it’s an external facing app, I look to sign it with Let’s Encrypt. In my head, this makes me feel a little bit better in case a device on my network is compromised and begins snooping.</li>
  <li>The Node-RED webhook endpoint is unable to run both <code class="highlighter-rouge">HTTP</code> &amp; <code class="highlighter-rouge">HTTPS</code> at the same time. I’m not quite sure why this occurred, but it may have something to do with the Node-RED implementation I am using. This means I cannot use SSL locally on Node-RED if I want to use the webhook from Plex.</li>
  <li>Without setting up a (reverse?) proxy through nginx (or the likes) and using an external CA like <a href="https://letsencrypt.org/">Let’s Encrypt</a>, I’m unable to <code class="highlighter-rouge">POST</code> requests from Plex webhooks because Plex does not recognize my local CA (and why would it?) causing them to fail.</li>
</ol>

<h2 id="sticking-with-home-assistant-webhooks">Sticking with Home Assistant webhooks</h2>

<p>That means the solution I chose to use were the newly introduced webhooks for Home Assistant.</p>

<blockquote>
  <p>My rationale behind this decision is that because I am already exposing Home Assistant externally, and I would prefer not to open another attack vector with Node-RED, I might as well just use the <code class="highlighter-rouge">HTTPS</code> endpoint on Home Assistant. If I was not already exposing Home Assistant externally, I likely would have kept using the non-ssl webhook from Node-RED locally.</p>
</blockquote>

<p>On this <a href="https://community.home-assistant.io/t/plex-webhooks-wip/73095">Home Assistant community post</a>, rossdargan had this great idea to parse the incoming <code class="highlighter-rouge">JSON</code> (disguised in a <code class="highlighter-rouge">form-data</code> message), and push it back to the local MQTT server so it could be read properly by the automations. I added the following to my <code class="highlighter-rouge">automations.yaml</code> and it worked great. I’m still not completely satisfied with the parsing though. I do wish it was using a proper parsing library instead..</p>

<h3 id="parsing-and-sending-the-payload-to-mqtt">Parsing and sending the payload to MQTT</h3>

<p>Plex webhooks have a problem where they send their <code class="highlighter-rouge">json</code> payload with a <code class="highlighter-rouge">Content-Type</code> header of <code class="highlighter-rouge">form-data</code> instead of <code class="highlighter-rouge">application/json</code>. That’s why we have have to parse the “<code class="highlighter-rouge">data</code>” from the payload first, and repost it through a local MQTT channel before being able to interpret it as a <code class="highlighter-rouge">json</code> object.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># Home Assistant automations.yaml</span>
<span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1539725480000'</span>
  <span class="na">alias</span><span class="pi">:</span> <span class="s">Plex Webhook MQTT</span>
  <span class="na">trigger</span><span class="pi">:</span>
    <span class="na">platform</span><span class="pi">:</span> <span class="s">webhook</span>
    <span class="na">webhook_id</span><span class="pi">:</span> <span class="kt">!secret</span> <span class="s">plex_webhook</span>
  <span class="na">action</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">service</span><span class="pi">:</span> <span class="s">mqtt.publish</span>
     <span class="na">data_template</span><span class="pi">:</span>
       <span class="na">topic</span><span class="pi">:</span> <span class="s1">'</span><span class="s">plex/update'</span>
       <span class="na">payload_template</span><span class="pi">:</span> <span class="pi">&gt;</span>
         <span class="s">{{ (trigger.data['payload'] | string)[12:][:-2] | replace ("\\\\", "\\") | replace ("\\\'", "'") | replace ("\\x","?") }}</span>

</code></pre></div></div>

<h3 id="receiving-the-mqtt-message">Receiving the MQTT message</h3>

<p>After that automation is set, we can listen to the MQTT channel and check its conditions. In the automation below, I check to see who is watching TV and which player UUID they are using. I’m not sure the best way to find the UUID other than checking the logs or debugging the Plex webhook messages.</p>

<p>Once these conditions are met, I check the playback state of the event being received. If it’s starting/resuming, I flip on a boolean value for <code class="highlighter-rouge">plex_playback</code>. If it’s stopping/pausing, I flip that boolean value off.</p>

<p>That boolean value is what I use to determine the playback state for my other automations in Node-RED. In my case, it works like this:</p>

<p>If <code class="highlighter-rouge">plex_playback</code> value is turned on, I will check the following conditions in Node-RED before dimming the lights.</p>

<ul>
  <li>
<code class="highlighter-rouge">Is anyone cooking in the kitchen?</code> If true, don’t dim the kitchen lights.</li>
  <li>
<code class="highlighter-rouge">Is this content the morning news?</code> If true, don’t dim any lights. I need to wake up.</li>
  <li>
<code class="highlighter-rouge">Is the master light override control on?</code> If true, leave all lights where they are.</li>
</ul>

<p>If <code class="highlighter-rouge">plex_playback</code> value is turned off, I will check the following conditions in Node-RED before brightening the lights.</p>

<ul>
  <li>
<code class="highlighter-rouge">Is the sun angle lower than 8°</code> If true, don’t brighten the lights. It’s too late at night for that.</li>
  <li>
<code class="highlighter-rouge">Is the master light override control on?</code> If true, leave all lights where they are.</li>
</ul>

<p>Here’s the automation for changing the boolean value:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Home Assistant automations.yaml</span>
<span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s1">'</span><span class="s">1539522762000'</span>
  <span class="na">alias</span><span class="pi">:</span> <span class="s">Plex State Toggle</span>
  <span class="na">trigger</span><span class="pi">:</span>
    <span class="na">platform</span><span class="pi">:</span> <span class="s">mqtt</span>
    <span class="na">topic</span><span class="pi">:</span> <span class="s1">'</span><span class="s">plex/update'</span>
  <span class="na">condition</span><span class="pi">:</span>
    <span class="na">condition</span><span class="pi">:</span> <span class="s">and</span>
    <span class="na">conditions</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">template</span>
      <span class="na">value_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{trigger.payload_json.Account['title']</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">'PLEX_USER'</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">template</span>
      <span class="na">value_template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{trigger.payload_json.Player['uuid']</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">'PLAYER_UUID'</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="pi">-</span> <span class="na">condition</span><span class="pi">:</span> <span class="s">template</span>
  <span class="na">action</span><span class="pi">:</span>
    <span class="na">service_template</span><span class="pi">:</span> <span class="pi">&gt;</span>
        <span class="s">{% if ((trigger.payload_json.event == 'media.play') or (trigger.payload_json.event == 'media.resume')) %}</span>
          <span class="s">input_boolean.turn_on</span>
        <span class="s">{% elif ((trigger.payload_json.event == 'media.pause') or (trigger.payload_json.event == 'media.stop')) %}</span>
          <span class="s">input_boolean.turn_off</span>
        <span class="s">{% endif %}</span>
    <span class="na">entity_id</span><span class="pi">:</span> <span class="s">input_boolean.plex</span>
</code></pre></div></div>

<blockquote>
  <p>After HomeAssistant introduced their <a href="https://www.nabucasa.com/config/webhooks/">Cloud Webhook</a> in <code class="highlighter-rouge">0.84.0</code>, my <code class="highlighter-rouge">payload_template</code> for the incoming WebHooks needed to be changed to <code class="highlighter-rouge">{{ (trigger.data | string)[154:][:-55] }}</code> until HomeAssistant is able to handle JSON payloads in multipart data WebHooks. It’s a <em>terrible</em> solution and entirely based on assumed headers of the payload, but it works for now.</p>
</blockquote>

<h2 id="conclusion">Conclusion</h2>

<p>There you have it. The quickest (non-deprecated) method I could come up with for changing my lights when starting/stopping content on Plex. I’m sure there are ways to improve this. That’s ok, I don’t mind. This was only a weekend project to improve my lighting events. If only Plex states could be monitored as quickly as my Chromecast can be. One can only dream…</p>


  </article>
</main>


<a href="/blog/2018/10/dimming-lights-with-plex-and-homeassistant/" class="meta center">Comments are available on the full webpage.</a>


<!-- start footer -->
<footer class="content">
  <div class="flex-list">
  <ul>
  
    <li>
      <a href="https://www.linkedin.com/in/kyleniewiada/">LinkedIn</a>
    </li>
  
    <li>
      <a href="https://github.com/aav7fl">GitHub</a>
    </li>
  
    <li>
      <a href="https://twitter.com/CrypticCitrus">Twitter</a>
    </li>
  
    <li>
      <a href="https://www.youtube.com/user/KyleNiewiada">YouTube</a>
    </li>
  
    <li>
      <a href="https://kyleniewiada.bandcamp.com/" rel="nofollow">BandCamp</a>
    </li>
  
    <li>
      <a href="/sitemap/">Sitemap</a>
    </li>
  
  </ul>
</div>

</footer>
<!-- end footer -->


</body>

</html>
